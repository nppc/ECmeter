
#include "main.h"
#include "SSD1306.h"
#include "i2c.h"

static const uint8_t code num_font_bitmap[] = {
    // 'FontECmeter0', 18x32px
    0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf0, 0xf8, 0x78, 0x78, 0x78, 0xf8, 0xf8, 0xf0, 0xf0, 0xe0, 0x80,
    0x00, 0x00, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff,
    0xff, 0xff, 0xfc, 0x00, 0x0f, 0x7f, 0xff, 0xff, 0xff, 0xf0, 0xc0, 0x80, 0x80, 0x80, 0xc0, 0xf0,
    0xff, 0xff, 0xff, 0x7f, 0x0f, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00,
    // 'FontECmeter1', 18x32px
    0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x03, 0x03, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 'FontECmeter2', 18x32px
    0x00, 0x00, 0xe0, 0xf0, 0xf0, 0x78, 0x78, 0x78, 0x78, 0x78, 0xf8, 0xf8, 0xf0, 0xf0, 0xe0, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xc0, 0xf0, 0xff, 0xff, 0xff,
    0x3f, 0x1f, 0x00, 0x00, 0x00, 0xc0, 0xf0, 0xf8, 0xfc, 0xfe, 0xbf, 0x9f, 0x8f, 0x87, 0x83, 0x81,
    0x81, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x00, 0x00,
    // 'FontECmeter3', 18x32px
    0x00, 0x00, 0x00, 0xf0, 0x70, 0x78, 0x78, 0x78, 0x78, 0xf8, 0xf8, 0xf0, 0xf0, 0xe0, 0xc0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf0, 0xff, 0xbf, 0xbf, 0x1f,
    0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xc0, 0x81, 0x81, 0x81, 0x81, 0x81, 0x83, 0xc3, 0xff,
    0xff, 0xff, 0xff, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00,
    // 'FontECmeter4', 18x32px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xf0, 0xf8, 0x7e, 0x3f, 0x0f, 0x07, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x00, 0x00, 0x00, 0x3e, 0x3f, 0x3f, 0x3f, 0x3f, 0x3d, 0x3c, 0x3c, 0x3c, 0x3c, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x3c, 0x3c, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x00, 0x00, 0x00,
    // 'FontECmeter5', 18x32px
    0x00, 0x00, 0x00, 0xf8, 0xf8, 0xf8, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0,
    0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xc1, 0xe3, 0xff,
    0xff, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00,
    // 'FontECmeter6', 18x32px
    0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf0, 0xf8, 0x78, 0x78, 0x78, 0x78, 0x78, 0xf8, 0x00,
    0x00, 0x00, 0x00, 0xf0, 0xfe, 0xff, 0xff, 0xff, 0xc7, 0xe1, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0,
    0xe0, 0xc0, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xff, 0xff, 0xff, 0xe1, 0x80, 0x80, 0x80, 0x80, 0xc1,
    0xff, 0xff, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    // 'FontECmeter7', 18x32px
    0x00, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8,
    0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xf8, 0xfe, 0xff, 0x7f, 0x1f,
    0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xfc, 0xff, 0xff, 0xff, 0x0f, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x07, 0x07, 0x07, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 'FontECmeter8', 18x32px
    0x00, 0x80, 0xe0, 0xf0, 0xf0, 0xf8, 0xf8, 0x78, 0x78, 0x78, 0xf8, 0xf8, 0xf0, 0xf0, 0xe0, 0x80,
    0x00, 0x00, 0x00, 0x07, 0x1f, 0xbf, 0xbf, 0xff, 0xf8, 0xf0, 0xe0, 0xf0, 0xf8, 0xff, 0xff, 0x9f,
    0x1f, 0x07, 0x00, 0x00, 0x7c, 0xff, 0xff, 0xff, 0xff, 0xc3, 0x81, 0x81, 0x80, 0x81, 0xc1, 0xc3,
    0xff, 0xff, 0xff, 0xff, 0x7c, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    // 'FontECmeter9', 18x32px
    0x00, 0x00, 0xc0, 0xe0, 0xf0, 0xf0, 0xf8, 0x78, 0x78, 0x78, 0xf8, 0xf8, 0xf0, 0xf0, 0xe0, 0x80,
    0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xe1, 0x80, 0x80, 0x80, 0xc0, 0xe1, 0xff, 0xff,
    0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0xc1, 0x83, 0x83, 0x87, 0x87, 0x87, 0x87, 0xc7, 0xe3, 0xf1,
    0xff, 0xff, 0x7f, 0x3f, 0x07, 0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 'FontECmeterMinus', 18x32px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0,
    0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};


static const uint8_t code dot_bitmap[] = {
    // 'FontECmeterDot', 6x32px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xc0,
    0xc0, 0x80, 0x03, 0x07, 0x07, 0x07, 0x07, 0x03,
};


void ssd1306_printDigitLine(uint8_t line, uint8_t digit);


void ssd1306_init(void){
  uint8_t i,d;
  ssd1306_send_command_start();
  for (i = 0; i < init_sequence_length; i++) {
    d=initSSD1306sq[i];
    I2C_Write(d);
  }
  I2C_Stop();
}


void ssd1306_send_command_start(void){
  i2cBegin(0x3C, 0); // address of SSD1306
  I2C_Write(SSD1306_COMMAND);
}

void ssd1306_send_command(uint8_t cmd){
  ssd1306_send_command_start();
  I2C_Write(cmd);
  I2C_Stop();
}

void ssd1306_write_display_start(void){
  i2cBegin(0x3C, 0); // address of SSD1306
  I2C_Write(SSD1306_DATA);
}


void setCol(uint8_t col) {
  ssd1306_send_command(SSD1306_SETLOWCOLUMN | (col & 0XF));
  ssd1306_send_command(SSD1306_SETHIGHCOLUMN | (col >> 4));
}


void setRow(uint8_t row) {
  ssd1306_send_command(SSD1306_SETSTARTPAGE | row);
}

void ssd1306_clear_display(void){
uint8_t i,i1;
  for(i1=0;i1<4;i1++){
    setCol(0);
    setRow(i1);
    ssd1306_write_display_start();
    for(i=0;i<128;i++){
      I2C_Write(0);
    }
    I2C_Stop();
  }
  setCol(0);
  setRow(0);
}

// 0.00 - 9.99
void ssd1306_printNumber(int16_t num){
  // convert binary number to BCD
  uint8_t i, a[3];
  int16_t tmp;
  if(num<1000){
      tmp = num;
      a[0] = tmp / 100;
      tmp = tmp % 100;
      a[1] = tmp / 10;
      tmp = tmp % 10;
      a[2] = tmp;
  }else{
      a[0]=10;
      a[1]=10;
      a[2]=10;
  }
  // now print to LCD
  // we print 4 rows and 3 digits with dot
  for(tmp=0;tmp<4;tmp++){
    setCol(128-((number_width+2)*3+dot_width)); // set the position
    setRow(tmp);
    // first digit
    ssd1306_write_display_start();
    ssd1306_printDigitLine(tmp,a[0]);
    I2C_Write(0);
    I2C_Write(0);
    // print dot
    for(i=0;i<dot_width;i++){
      I2C_Write(dot_bitmap[i+tmp*dot_width]);
    }
    I2C_Write(0);
    I2C_Write(0);
    // print second digit
    ssd1306_printDigitLine(tmp,a[1]);
    I2C_Write(0);
    I2C_Write(0);
    // print third digit
    ssd1306_printDigitLine(tmp,a[2]);
    I2C_Stop();
  }

}

void ssd1306_printDigitLine(uint8_t line, uint8_t digit){
  uint8_t i,tmp1;
  uint16_t tmp;
  for(i=0;i<number_width;i++){
    tmp = (i+line*number_width)+digit*number_width*4;
    tmp1 = num_font_bitmap[tmp];
    I2C_Write(tmp1);
  }
}

// x,y - position (x:0-127,y:0-3)
//w,h - size (w:0-127,h:0-3)
void ssd1306_printBitmap(uint8_t x, uint8_t y, uint8_t w, uint8_t h, uint8_t code *bmp){
  uint8_t ih, iw;
  uint16_t addr=0;
  for(ih=0;ih<h;ih++){
    setCol(x); // set the position
    setRow(y);
    ssd1306_write_display_start();
    for(iw=0;iw<w;iw++){
      I2C_Write(bmp[addr]);
      addr++;
    }
    I2C_Stop();
    y++;
  }
}

// x,y - position (x:0-127,y:0-3)
//w,h - size (w:0-127,h:0-3)
void ssd1306_printBitmapClear(uint8_t x, uint8_t y, uint8_t w, uint8_t h){
  uint8_t ih, iw;
  for(ih=0;ih<h;ih++){
    setCol(x); // set the position
    setRow(y);
    ssd1306_write_display_start();
    for(iw=0;iw<w;iw++){
      I2C_Write(0);
    }
    I2C_Stop();
    y++;
  }
}

#ifdef DEBUG
// 0000 - 9999
void ssd1306_printNumberDebug(int16_t num){
  // convert binary number to BCD
  uint8_t a[4];
  int16_t tmp;
  if(num<10000){
      tmp = num;
      a[0] = tmp / 1000;
      tmp = tmp % 1000;
      a[1] = tmp / 100;
      tmp = tmp % 100;
      a[2] = tmp / 10;
      tmp = tmp % 10;
      a[3] = tmp;
  }else{
      a[0]=10;
      a[1]=10;
      a[2]=10;
      a[3]=10;
  }
  // now print to LCD
  // we print 4 rows and 3 digits with dot
  for(tmp=0;tmp<4;tmp++){
    setCol(128-((number_width+1)*4)); // set the position
    setRow(tmp);
    ssd1306_write_display_start();
    // first digit
    ssd1306_printDigitLine(tmp,a[0]);
    I2C_Write(0);
    // print second digit
    ssd1306_printDigitLine(tmp,a[1]);
    I2C_Write(0);
    // print third digit
    ssd1306_printDigitLine(tmp,a[2]);
    I2C_Write(0);
    // print last digit
    ssd1306_printDigitLine(tmp,a[3]);
    I2C_Stop();
  }
}
#endif
